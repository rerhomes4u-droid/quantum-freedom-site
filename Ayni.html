<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYNI SANTUARIO - Medicina de la Tierra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --earth: #8B4513;
            --forest: #2E8B57;
            --sun: #D4AF37;
            --sky: #87CEEB;
            --clay: #DEB887;
            --spirit: #6A0DAD;
            --love: #E23E57;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Georgia', serif; }
        body { background: linear-gradient(135deg, #f5f1eb, #e8f5e9); color: #333; min-height: 100vh; }
        .app-container { max-width: 1400px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 40px rgba(139, 69, 19, 0.1); }
        
        /* Header & Navigation */
        .header-section {
            background: linear-gradient(rgba(0,0,0,0.85), rgba(46, 139, 87, 0.9)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center; color: white; padding: 3rem 1.5rem; text-align: center; position: relative; overflow: hidden;
        }
        .earth-badge { background: rgba(212, 175, 55, 0.9); color: var(--earth); border-radius: 50px; padding: 0.75rem 2rem; margin: 0 auto 1.5rem; display: inline-block; font-weight: bold; font-size: 1.1rem; letter-spacing: 1px; }
        .main-title { font-size: 3.5rem; margin-bottom: 1rem; font-family: 'Playfair Display', serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.3rem; margin-bottom: 2rem; opacity: 0.95; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.7; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; max-width: 900px; margin: 2.5rem auto 0; }
        .stat-box { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 15px; padding: 1.5rem; border: 1px solid rgba(212, 175, 55, 0.3); }
        .stat-number { font-size: 2.8rem; font-weight: bold; color: var(--sun); line-height: 1; }
        .stat-label { font-size: 0.95rem; opacity: 0.9; margin-top: 0.5rem; }
        
        /* Mission & Loading */
        .mission-statement { background: linear-gradient(135deg, rgba(139, 69, 19, 0.08), rgba(46, 139, 87, 0.08)); border-radius: 20px; padding: 2.5rem; margin: 2.5rem; border-left: 6px solid var(--forest); font-size: 1.2rem; line-height: 1.9; text-align: center; font-style: italic; color: var(--earth); }
        #loadingProducts { text-align: center; padding: 3rem; color: var(--forest); font-size: 1.2rem; }
        .spinner { border: 5px solid rgba(46, 139, 87, 0.2); border-radius: 50%; border-top: 5px solid var(--forest); width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Products Grid */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; padding: 2rem; }
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.08); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #eee; position: relative; }
        .product-card:hover { transform: translateY(-12px) scale(1.01); box-shadow: 0 20px 40px rgba(139, 69, 19, 0.15); border-color: var(--sun); }
        .product-image { height: 240px; width: 100%; background: linear-gradient(135deg, var(--clay), #a3d9a5); position: relative; overflow: hidden; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .product-card:hover .product-image img { transform: scale(1.08); }
        .product-badge { position: absolute; top: 15px; right: 15px; background: var(--love); color: white; padding: 0.4rem 1.2rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; z-index: 10; }
        .product-content { padding: 1.8rem; }
        .product-header { display: flex; align-items: flex-start; margin-bottom: 1.2rem; }
        .product-icon { min-width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--sun), #ffd700); display: flex; align-items: center; justify-content: center; font-size: 1.6rem; margin-right: 1.2rem; color: var(--earth); }
        .product-info h3 { font-size: 1.5rem; margin-bottom: 0.4rem; color: var(--earth); line-height: 1.3; }
        .product-origin { color: var(--forest); font-style: italic; font-size: 0.95rem; }
        .product-description { margin: 1.2rem 0; line-height: 1.7; color: #555; font-size: 1rem; }
        .product-benefits { background: rgba(139, 69, 19, 0.05); border-radius: 12px; padding: 1.2rem; margin: 1.2rem 0; }
        .benefits-title { font-weight: bold; margin-bottom: 0.7rem; color: var(--forest); font-size: 1rem; }
        .benefits-list { font-size: 0.9rem; line-height: 1.6; }
        .product-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee; }
        .product-price-area .product-price { font-size: 1.8rem; font-weight: bold; color: var(--earth); }
        .product-price-area .price-note { font-size: 0.85rem; color: var(--forest); margin-top: 0.3rem; }
        .stock-indicator { font-size: 0.85rem; padding: 0.3rem 0.8rem; border-radius: 12px; font-weight: bold; }
        .stock-in { background: rgba(46, 139, 87, 0.1); color: var(--forest); }
        .stock-low { background: rgba(226, 62, 87, 0.1); color: var(--love); }
        .purchase-btn { background: linear-gradient(to right, var(--forest), #34a853); color: white; border: none; border-radius: 12px; padding: 1rem 2.2rem; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.7rem; }
        .purchase-btn:hover { background: linear-gradient(to right, var(--earth), var(--forest)); transform: translateY(-3px); box-shadow: 0 7px 15px rgba(46, 139, 87, 0.3); }
        .purchase-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Cart System */
        #cartIndicator { position: fixed; bottom: 2rem; right: 2rem; background: linear-gradient(135deg, var(--forest), #25a244); color: white; padding: 1rem 2rem; border-radius: 50px; cursor: pointer; z-index: 1000; box-shadow: 0 8px 25px rgba(46, 139, 87, 0.4); font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 0.8rem; transition: all 0.3s ease; }
        #cartIndicator:hover { transform: scale(1.08); box-shadow: 0 12px 30px rgba(46, 139, 87, 0.6); }
        #cartIndicator i { font-size: 1.3rem; }
        .cart-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.3s ease; }
        .cart-modal { background: white; border-radius: 25px; width: 95%; max-width: 700px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); animation: slideUp 0.4s ease; }
        .cart-header { background: linear-gradient(135deg, var(--earth), var(--forest)); color: white; padding: 1.8rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h3 { font-size: 1.8rem; margin: 0; }
        .close-cart { background: none; border: none; color: white; font-size: 2.5rem; cursor: pointer; line-height: 1; }
        .cart-items { padding: 1.5rem 2rem; flex-grow: 1; overflow-y: auto; max-height: 50vh; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 0; border-bottom: 1px solid #eee; }
        .cart-item-info h4 { color: var(--earth); margin-bottom: 0.3rem; }
        .cart-item-meta { color: #666; font-size: 0.9rem; }
        .cart-item-controls { display: flex; align-items: center; gap: 1rem; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--forest); background: white; color: var(--forest); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qty-btn:hover { background: var(--forest); color: white; }
        .item-qty { font-weight: bold; min-width: 30px; text-align: center; }
        .item-total { font-weight: bold; color: var(--earth); min-width: 100px; text-align: right; }
        .remove-item { background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem; margin-left: 1rem; }
        .cart-footer { background: #f9f9f9; padding: 1.8rem 2rem; border-top: 2px solid #eee; }
        .cart-total { display: flex; justify-content: space-between; align-items: center; font-size: 1.8rem; font-weight: bold; color: var(--earth); margin-bottom: 1.5rem; }
        .cart-actions { display: flex; gap: 1rem; }
        .cart-btn { flex: 1; padding: 1.2rem; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; }
        .continue-btn { background: #e0e0e0; color: #333; }
        .checkout-btn { background: linear-gradient(to right, var(--sun), #e6b800); color: var(--earth); }
        .continue-btn:hover { background: #d0d0d0; }
        .checkout-btn:hover { background: linear-gradient(to right, #e6b800, var(--sun)); transform: translateY(-3px); }
        
        /* WhatsApp & Impact Sections */
        .whatsapp-section { background: linear-gradient(135deg, #25D366, #128C7E); color: white; border-radius: 25px; margin: 3rem; padding: 3rem; text-align: center; box-shadow: 0 15px 35px rgba(37, 211, 102, 0.3); }
        .whatsapp-buttons { display: flex; gap: 2rem; justify-content: center; margin-top: 2.5rem; flex-wrap: wrap; }
        .whatsapp-btn { padding: 1.5rem 3rem; border-radius: 16px; text-decoration: none; font-weight: bold; font-size: 1.2rem; display: inline-flex; flex-direction: column; align-items: center; transition: all 0.4s ease; min-width: 280px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .orders-btn { background: white; color: #128C7E; }
        .alliances-btn { background: var(--sun); color: var(--earth); }
        .whatsapp-btn:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 18px 35px rgba(0,0,0,0.3); }
        .impact-section { background: linear-gradient(135deg, rgba(106, 13, 173, 0.05), rgba(226, 62, 87, 0.05)); border-radius: 25px; padding: 3rem; margin: 3rem; text-align: center; }
        .impact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 2rem; margin: 2.5rem 0; }
        .impact-card { background: white; border-radius: 18px; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.07); transition: transform 0.3s ease; }
        .impact-card:hover { transform: translateY(-10px); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Responsive */
        @media (max-width: 1100px) { .products-grid { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); } }
        @media (max-width: 768px) {
            .products-grid { grid-template-columns: 1fr; padding: 1.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
            .main-title { font-size: 2.5rem; }
            .mission-statement, .whatsapp-section, .impact-section { margin: 1.5rem; padding: 2rem; }
            .whatsapp-buttons { flex-direction: column; align-items: center; }
            .whatsapp-btn { min-width: 90%; }
            #cartIndicator { bottom: 1.5rem; right: 1.5rem; padding: 0.9rem 1.8rem; font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="header-section">
            <div class="earth-badge"><i class="fas fa-seedling"></i> TIERRA ‚Ä¢ AMOR ‚Ä¢ COMUNIDAD</div>
            <h1 class="main-title">AYNI SANTUARIO</h1>
            <p class="subtitle">Medicina de la Tierra desde el Coraz√≥n de Colombia. Productos que sanan, comunidades que florecen, tierra que respira.</p>
            <div class="stats-grid" id="dynamicStats">
                <!-- Stats loaded by JavaScript -->
            </div>
        </header>

        <!-- MISSION -->
        <div class="mission-statement">
            <i class="fas fa-quote-left" style="font-size: 2rem; color: var(--sun); display: block; margin-bottom: 1rem;"></i>
            "No vendemos productos - compartimos medicina de la tierra. Cada compra protege territorio andino, sostiene comunidades ind√≠genas y mantiene viva la sabidur√≠a ancestral. Este es comercio que respira, que sana, que transforma."
        </div>

        <!-- PRODUCTS SECTION -->
        <h2 class="section-title" id="products"><i class="fas fa-spa"></i> Medicina de la Tierra</h2>
        <div id="loadingProducts">
            <div class="spinner"></div>
            <p>Cargando medicina de la tierra desde el santuario...</p>
        </div>
        <div class="products-grid" id="productsContainer">
            <!-- Products are loaded here by JavaScript -->
        </div>

        <!-- WHATSAPP CONNECTION -->
        <div class="whatsapp-section">
            <h3><i class="fab fa-whatsapp"></i> Con√©ctate con la Tierra</h3>
            <p style="font-size: 1.2rem; margin-top: 1rem; opacity: 0.95;">Haz tu pedido directamente o conversa sobre alianzas para el santuario.</p>
            <div class="whatsapp-buttons">
                <a href="https://wa.me/573226921775" class="whatsapp-btn orders-btn" target="_blank" id="whatsappOrderBtn">
                    <span><i class="fas fa-box"></i> PEDIDOS & ENV√çOS</span>
                    <small>+57 322 692 1775</small>
                </a>
                <a href="https://wa.me/573223319416" class="whatsapp-btn alliances-btn" target="_blank">
                    <span><i class="fas fa-handshake"></i> ALIANZAS ANCESTRALES</span>
                    <small>+57 322 331 9416</small>
                </a>
            </div>
        </div>

        <!-- IMPACT -->
        <div class="impact-section" id="impact">
            <h3 class="impact-title"><i class="fas fa-globe-americas"></i> Tu Compra Protege la Tierra</h3>
            <p style="font-size: 1.1rem; max-width: 800px; margin: 1rem auto;">Cuando compras en AYNI, no solo recibes medicina pura - te unes a un movimiento de protecci√≥n planetaria.</p>
            <div class="impact-grid">
                <div class="impact-card"><div class="impact-icon">üå≥</div><div class="impact-text">Protecci√≥n de 5 hect√°reas de bosque nativo por cada 10 productos vendidos</div></div>
                <div class="impact-card"><div class="impact-icon">üë©‚Äçüåæ</div><div class="impact-text">Sostenimiento de 8 familias ind√≠genas guardianas del territorio</div></div>
                <div class="impact-card"><div class="impact-icon">üíß</div><div class="impact-text">Conservaci√≥n de 3 fuentes h√≠dricas en el Macizo Colombiano</div></div>
                <div class="impact-card"><div class="impact-icon">üçØ</div><div class="impact-text">Protecci√≥n de 15 colmenas de abejas nativas polinizadoras</div></div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer>
            <div class="footer-title">AYNI SANTUARIO - Medicina de la Tierra</div>
            <p>Salento, Quind√≠o ‚Ä¢ Colombia<br>Parte del ecosistema <strong>TripsToColombia.com</strong></p>
            <p style="margin-top: 2rem; opacity: 0.8; font-size: 0.95rem; font-style: italic; max-width: 800px; margin-left: auto; margin-right: auto;">
                "No vendemos productos. Compartimos medicina. Protegemos territorio. Construimos comunidad.<br>Esta es nuestra guerra silenciosa por un mundo donde todo lo que consuma d√© vida en lugar de quitarla."
            </p>
        </footer>

        <!-- SHOPPING CART INDICATOR -->
        <div id="cartIndicator" onclick="openCartModal()">
            <i class="fas fa-shopping-basket"></i>
            <span id="cartCount">0</span> Productos
        </div>
    </div>

    <!-- CART MODAL (Hidden by default) -->
    <div id="cartModal" class="cart-modal-overlay" style="display: none;">
        <div class="cart-modal">
            <div class="cart-header">
                <h3><i class="fas fa-shopping-basket"></i> Tu Ritual de Sanaci√≥n</h3>
                <button class="close-cart" onclick="closeCartModal()">√ó</button>
            </div>
            <div class="cart-items" id="cartItemsContainer">
                <!-- Cart items appear here -->
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total del Ritual:</span>
                    <span id="cartTotalPrice">$0 COP</span>
                </div>
                <div class="cart-actions">
                    <button class="cart-btn continue-btn" onclick="closeCartModal()"><i class="fas fa-arrow-left"></i> Seguir Explorando</button>
                    <button class="cart-btn checkout-btn" onclick="finalizeOrder()"><i class="fab fa-whatsapp"></i> Completar por WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SUCCESS TOAST -->
    <div id="successToast" style="display: none; position: fixed; top: 30px; right: 30px; background: var(--forest); color: white; padding: 1.2rem 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 3000; animation: slideIn 0.5s ease;">
        <i class="fas fa-check-circle" style="margin-right: 10px;"></i> <span id="toastMessage">Producto agregado!</span>
    </div>

    <!-- JAVASCRIPT: THE ENGINE -->
    <script>
        // ========== CONFIGURATION ==========
        // üéØ CRITICAL: Replace with YOUR Google Apps Script Web App URL after deployment
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID_HERE/exec';

        const CONFIG = {
            STORE_CODE: 'AYNI_SALENTO_001',
            WHATSAPP_ORDERS: '573226921775',
            WHATSAPP_ALLIANCES: '573223319416'
        };

        // ========== GLOBAL STATE ==========
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('ayni_cart')) || [];
        let currentOrderId = null;

        // ========== INITIALIZE ON LOAD ==========
        document.addEventListener('DOMContentLoaded', function() {
            updateCartDisplay();
            loadProductsFromGoogleSheets();
            setupWhatsAppButton();
            updateDynamicStats();
        });

        // ========== LOAD PRODUCTS FROM GOOGLE SHEETS ==========
        async function loadProductsFromGoogleSheets() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                
                if (result.success) {
                    allProducts = result.products;
                    renderProducts(allProducts);
                    document.getElementById('loadingProducts').style.display = 'none';
                    showToast('‚úÖ Medicina cargada desde la tierra!');
                } else {
                    throw new Error(result.error || 'Failed to load products');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('loadingProducts').innerHTML = `
                    <div style="color: var(--love);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No se pudo cargar la medicina desde el santuario.</p>
                        <p><small>Error: ${error.message}</small></p>
                        <button onclick="loadProductsFromGoogleSheets()" style="margin-top: 1rem; padding: 0.8rem 1.5rem; background: var(--forest); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // ========== RENDER PRODUCTS TO PAGE ==========
        function renderProducts(products) {
            const container = document.getElementById('productsContainer');
            if (!container) return;
            
            container.innerHTML = products.map(product => {
                const isOutOfStock = parseInt(product.Stock) <= 0;
                const stockClass = isOutOfStock ? 'stock-low' : 'stock-in';
                const stockText = isOutOfStock ? 'AGOTADO' : `${product.Stock} disponibles`;
                
                return `
                    <div class="product-card" data-id="${product.ID}">
                        <div class="product-image">
                            <img src="${product.Image_URL}" alt="${product.Name}" loading="lazy">
                            <div class="product-badge">${product.Category || 'SABIDUR√çA'}</div>
                        </div>
                        <div class="product-content">
                            <div class="product-header">
                                <div class="product-icon">${getProductIcon(product.Category)}</div>
                                <div class="product-info">
                                    <h3>${product.Name}</h3>
                                    <div class="product-origin">${product.Origin || 'Coraz√≥n de Colombia'}</div>
                                </div>
                            </div>
                            <div class="product-description">${product.Description}</div>
                            
                            ${product.Benefits ? `
                            <div class="product-benefits">
                                <div class="benefits-title">Beneficios Ancestrales:</div>
                                <div class="benefits-list">${formatBenefits(product.Benefits)}</div>
                            </div>` : ''}
                            
                            <div class="product-meta">
                                <div class="product-price-area">
                                    <div class="product-price">${formatPrice(product.Price_COP)}</div>
                                    <div class="price-note">${product.Unit || 'Unidad sagrada'}</div>
                                </div>
                                <div class="stock-indicator ${stockClass}">${stockText}</div>
                            </div>
                            
                            <button class="purchase-btn" onclick="addToCart('${product.ID}')" ${isOutOfStock ? 'disabled' : ''}>
                                <i class="fas fa-plus-circle"></i>
                                ${isOutOfStock ? 'AGOTADO' : 'Agregar al Ritual'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== SHOPPING CART FUNCTIONS ==========
        function addToCart(productId) {
            const product = allProducts.find(p => p.ID == productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= parseInt(product.Stock)) {
                    showToast('‚ö†Ô∏è No hay m√°s unidades disponibles');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                if (parseInt(product.Stock) <= 0) {
                    showToast('‚ö†Ô∏è Producto agotado');
                    return;
                }
                cart.push({
                    id: productId,
                    name: product.Name,
                    price: parseInt(product.Price_COP),
                    quantity: 1,
                    image: product.Image_URL
                });
            }
            
            saveCart();
            updateCartDisplay();
            showToast(`‚úÖ ${product.Name} agregado al ritual`);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            updateCartDisplay();
            showToast('üóëÔ∏è Producto removido');
        }

        function updateCartQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            const product = allProducts.find(p => p.ID == productId);
            const newQty = item.quantity + change;
            
            if (newQty < 1) {
                removeFromCart(productId);
                return;
            }
            
            if (product && newQty > parseInt(product.Stock)) {
                showToast(`‚ö†Ô∏è M√°ximo ${product.Stock} disponibles`);
                return;
            }
            
            item.quantity = newQty;
            saveCart();
            updateCartDisplay();
        }

        function saveCart() {
            localStorage.setItem('ayni_cart', JSON.stringify(cart));
        }

        function updateCartDisplay() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cartCount').textContent = totalItems;
            document.getElementById('cartTotalPrice').textContent = formatPrice(totalPrice);
            
            // Update cart indicator visibility
            const indicator = document.getElementById('cartIndicator');
            indicator.style.display = totalItems > 0 ? 'flex' : 'none';
            
            // Update modal items
            updateCartModal();
        }

        // ========== CART MODAL FUNCTIONS ==========
        function openCartModal() {
            if (cart.length === 0) {
                showToast('Tu ritual est√° vac√≠o. Agrega medicina de la tierra.');
                return;
            }
            document.getElementById('cartModal').style.display = 'flex';
        }

        function closeCartModal() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function updateCartModal() {
            const container = document.getElementById('cartItemsContainer');
            if (!container) return;
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-leaf" style="font-size: 4rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>Tu ritual de sanaci√≥n est√° vac√≠o.</p>
                        <p><small>Agrega medicina de la tierra para comenzar.</small></p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cart.map(item => {
                const product = allProducts.find(p => p.ID == item.id);
                const itemTotal = item.price * item.quantity;
                
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div class="cart-item-meta">${formatPrice(item.price)} c/u</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateCartQuantity('${item.id}', -1)">‚àí</button>
                            <span class="item-qty">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateCartQuantity('${item.id}', 1)">+</button>
                            <div class="item-total">${formatPrice(itemTotal)}</div>
                            <button class="remove-item" onclick="removeFromCart('${item.id}')" title="Remover">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== CHECKOUT & WHATSAPP INTEGRATION ==========
        async function finalizeOrder() {
            if (cart.length === 0) {
                showToast('Tu ritual est√° vac√≠o.');
                return;
            }

            try {
                // 1. Prepare order data for Google Sheets
                const orderData = {
                    action: 'createOrder',
                    storeCode: CONFIG.STORE_CODE,
                    customerName: 'Cliente AYNI',
                    whatsapp: '', // Would be filled in a real form
                    email: '',
                    products: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price
                    })),
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    notes: 'Pedido desde la web AYNI SANTUARIO'
                };

                // 2. Send to Google Sheets via Apps Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                
                if (result.success) {
                    currentOrderId = result.orderId;
                    showToast(`‚úÖ Orden #${result.orderId} registrada en el santuario!`);
                    
                    // 3. Prepare WhatsApp message
                    sendOrderViaWhatsApp(result.orderId);
                    
                    // 4. Clear cart after successful submission
                    setTimeout(() => {
                        cart = [];
                        saveCart();
                        updateCartDisplay();
                        closeCartModal();
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'Failed to create order');
                }
                
            } catch (error) {
                console.error('Order submission error:', error);
                showToast('‚ö†Ô∏è Error al registrar la orden. Usa WhatsApp directamente.');
                // Fallback: Send to WhatsApp without sheet registration
                sendOrderViaWhatsApp('MANUAL-' + Date.now());
            }
        }

        function sendOrderViaWhatsApp(orderId) {
            const productList = cart.map(item => 
                `‚Ä¢ ${item.name} (${item.quantity}x): ${formatPrice(item.price * item.quantity)}`
            ).join('%0A');
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const message = `üåø *NUEVO PEDIDO AYNI SANTUARIO* üåø%0A%0A*Orden:* ${orderId}%0A*Fecha:* ${new Date().toLocaleDateString('es-CO')}%0A%0A*Medicina solicitada:*%0A${productList}%0A%0A*Total del Ritual:* ${formatPrice(total)}%0A%0A*Cliente:* [NOMBRE COMPLETO]%0A*Direcci√≥n:* [DIRECCI√ìN COMPLETA]%0A*Tel√©fono:* [TEL√âFONO]%0A%0A_This order was generated from the AYNI SANTUARIO web marketplace._`;
            
            const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_ORDERS}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function setupWhatsAppButton() {
            const btn = document.getElementById('whatsappOrderBtn');
            if (!btn || cart.length === 0) return;
            
            // Update WhatsApp button href with current cart contents
            const productList = cart.map(item => `${item.name} (${item.quantity}x)`).join(', ');
            const message = `Hola AYNI! Tengo inter√©s en estos productos de mi ritual: ${productList}. ¬øPodr√≠an ayudarme con el pedido?`;
            btn.href = `https://wa.me/${CONFIG.WHATSAPP_ORDERS}?text=${encodeURIComponent(message)}`;
        }

        // ========== HELPER FUNCTIONS ==========
        function formatPrice(price) {
            return '$' + parseInt(price).toLocaleString('es-CO') + ' COP';
        }

        function formatBenefits(benefits) {
            if (!benefits) return '';
            return benefits.split(';').map(b => `‚Ä¢ ${b.trim()}`).join('<br>');
        }

        function getProductIcon(category) {
            const icons = {
                'aceite': '‚ö´',
                'hongos': 'üçÑ',
                'aromaterapia': 'üí®',
                'miel': 'üêù',
                'pomada': 'üå±',
                'jabon': 'üßº',
                'kit': 'üéÅ'
            };
            return icons[category?.toLowerCase()] || 'üåø';
        }

        function showToast(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('toastMessage').textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function updateDynamicStats() {
            // This would fetch real stats in production
            const statsContainer = document.getElementById('dynamicStats');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-box"><div class="stat-number">9</div><div class="stat-label">Productos de la Tierra</div></div>
                    <div class="stat-box"><div class="stat-number">8</div><div class="stat-label">Comunidades Apoyadas</div></div>
                    <div class="stat-box"><div class="stat-number">100%</div><div class="stat-label">Org√°nico & Natural</div></div>
                    <div class="stat-box"><div class="stat-number">${cart.length}</div><div class="stat-label">Rituales Activos</div></div>
                `;
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('cartModal');
            if (event.target === modal) {
                closeCartModal();
            }
        });
    </script>
</body>
</html>
